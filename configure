#!/bin/bash

if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit
fi

echo "Start..."

chmod o+w ./mosquitto/data
chown 1883:1883 ./mosquitto/data -R
chmod o+w ./mosquitto/log
chmod o+w ./mosquitto/log/mosquitto.log
chown 1883:1883 ./mosquitto/log -R
chmod o+w ./mariadb
chmod +x restart

sed -i "s/\${SERVER_IP}/"`cat .env | grep SERVER_IP= | cut -d '=' -f2`"/" zigbee2mqtt/configuration.yaml
sed -i "s/\${HA_MYSQL_USER}/"`cat .env | grep HA_MYSQL_USER= | cut -d '=' -f2`"/" ha/configuration.yaml
sed -i "s/\${HA_MYSQL_PASSWORD}/"`cat .env | grep HA_MYSQL_PASSWORD= | cut -d '=' -f2`"/" ha/configuration.yaml
sed -i "s/\${HA_MYSQL_DATABASE}/"`cat .env | grep HA_MYSQL_DATABASE= | cut -d '=' -f2`"/" ha/configuration.yaml
sed -i "s/\${SERVER_IP}/"`cat .env | grep SERVER_IP= | cut -d '=' -f2`"/" ha/configuration.yaml

echo "Done!"
